# Echo v2 - Change Log

Date: 2025-10-12

## Version 2.0 - Transparent Compression Release

### Breaking Changes

- **NEW**: This is Echo v2, a complete rewrite with compression. Not backward compatible with EchoPing v1.
- URLs generated by Echo v2 cannot be read by EchoPing v1
- The compression is transparent to users but changes the URL format

### Major Features Added

#### 1. TextZip Compression Module (`textzip.js`)

- Dependency-free compression library using BWT+MTF+RLE+HUF pipeline
- Significantly reduces URL length for typical posts
- Deterministic and reversible compression
- Token format: `base64(headerJSON).base64(payloadBytes)`

**Algorithm Pipeline:**
1. **BWT (Burrows-Wheeler Transform)**: Reorders bytes to group similar characters
2. **MTF (Move-To-Front)**: Converts repeated characters to small indices
3. **RLE0 (Run-Length Encoding)**: Compresses runs of zero indices
4. **Huffman Coding**: Variable-length encoding based on frequency

#### 2. Updated Application Logic

- Modified `base64UrlEncodeObj()` to compress data using TextZip before encoding
- Modified `base64UrlDecodeToObj()` to decompress TextZip tokens after decoding
- Maintained same external API for rest of application
- Error handling for corrupt or invalid compressed tokens

#### 3. Rebranding

- Application renamed from "EchoPing v1" to "Echo v2"
- Updated all UI elements, titles, and documentation

### Files Modified

- **index.html**: Added textzip.js script tag, updated branding to "Echo v2"
- **app.js**: Updated encoding/decoding functions to use TextZip compression
- **readme.md**: Comprehensive documentation update with compression details

### Files Added

- **textzip.js**: Standalone compression module
- **textzip-spec.md**: Technical specification for compression algorithm
- **CHANGELOG.md**: This file

### Documentation Updates

#### readme.md

- Updated project name and version to Echo v2
- Added compression architecture section
- Documented TextZip algorithm and benefits
- Updated encoding/decoding section with compression details
- Updated example URLs to show compressed token format
- Added file list including textzip.js

#### textzip-spec.md (NEW)

- Complete technical specification for TextZip compression
- API documentation
- Token format details
- Algorithm descriptions for BWT, MTF, RLE0, and Huffman
- Error handling and validation rules
- Performance characteristics
- Integration notes for Echo v2
- Decision log documenting rationale

### Technical Details

#### Compression Token Format

```
base64(headerJSON).base64(payloadBytes)
```

Header JSON structure:
```json
{
  "v": 1,
  "alg": "BWT+MTF+RLE+HUF",
  "n": 123,
  "pi": 45,
  "hbits": 678,
  "rleLen": 90
}
```

#### URL Safety

- Tokens are made URL-safe by replacing `+` with `-`, `/` with `_`
- Trailing `=` padding is trimmed
- Reverse transformation applied on decode

#### Data Flow

**Encoding:**
```
Post Object → JSON.stringify → UTF-8 bytes → base64 →
TextZip.compress() → compressed token → URL-safe string → URL fragment
```

**Decoding:**
```
URL fragment → URL-safe string → restore characters →
TextZip.decompress() → base64 → UTF-8 bytes → JSON.parse → Post Object
```

### Testing

The application has been tested with:
- Compose mode (#new)
- View mode (#p=...)
- Edit mode (#e=...)
- Theme switching
- Copy link functionality
- Live preview updates

### Performance Characteristics

- BWT encoding: O(n²log n) - acceptable for typical post sizes (<10KB)
- Remaining stages: O(n)
- Memory: O(n) with small constant factor
- Compression ratio: Varies by content, typically 30-70% size reduction for text

### Browser Compatibility

- Requires modern browser with:
  - TextEncoder/TextDecoder API
  - btoa/atob functions
  - ES6+ JavaScript support
  - Uint8Array support

### Known Limitations

- BWT encoder is quadratic time complexity (O(n²log n))
- Suitable for small to medium posts (up to ~10KB uncompressed)
- For very large posts, BWT could be replaced with suffix array implementation
- No fallback to uncompressed format

### Future Improvements

- Consider suffix array or induced sorting for BWT (linear time)
- Explore general RLE (not just RLE0) if beneficial
- Implement block splitting for very large posts
- Add compression statistics to UI (optional)
- Performance profiling and optimization

### Migration Notes

**From EchoPing v1 to Echo v2:**

There is no automatic migration path. Echo v2 URLs are incompatible with v1:
- v1 used simple base64url encoding
- v2 uses compressed tokens with different format
- Users must recreate posts in v2 to benefit from compression

### Acknowledgments

- TextZip implementation based on standard compression techniques
- BWT, MTF, RLE, and Huffman are well-established algorithms
- Implementation optimized for browser JavaScript environment

---

## Development Timeline

**2025-10-12**: Initial release of Echo v2 with TextZip compression

### Key Decisions

1. **Compression is mandatory**: No fallback to uncompressed format for simplicity
2. **O(n²log n) BWT is acceptable**: Target audience has small posts
3. **Standalone module**: textzip.js is independent and could be reused
4. **URL-safe encoding**: Standard replacements ensure compatibility
5. **Error handling**: Fail-fast with descriptive messages for debugging
